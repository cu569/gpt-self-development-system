<!--
  ì™„ì „ ìë™í™” NIMA (ë¦¬ë§ˆ) ë¶„ì‚° AI ì‹œìŠ¤í…œ
  - ë³µë¶™ í•œë°©: Github Pages, Vercel, Netlify ì–´ë””ë“  ë°”ë¡œ ë°°í¬ ê°€ëŠ¥
  - P2P ë¶„ì‚° ë™ê¸°í™”, AI ì½”ì¹˜, ì±„íŒ…, ìŒì„± ì…ë ¥ê¹Œì§€!
  - 10ì–µëª… ì—…ë°ì´íŠ¸ë„ í•œ ë²ˆì— ë™ê¸°í™”
-->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>NIMA ë¶„ì‚° AI ì½”ì¹˜ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN for ë””ìì¸ (ë‹¤í¬/ë¼ì´íŠ¸) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM CDN (ìµœì‹ ) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- OrbitDB & IPFS Core: ë¶„ì‚° DB/CDNìš© (ë¸Œë¼ìš°ì € ì „ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/ipfs-core/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/orbit-db/dist/orbitdb.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-indigo-900 min-h-screen flex flex-col">
  <div id="root" class="flex-1 flex flex-col"></div>
  <script type="text/javascript">
    // ---- í•µì‹¬ ì½”ë“œ: NIMA ë¶„ì‚° AI ì‹œìŠ¤í…œ ----

    const { useState, useEffect, useRef } = React;

    // ë¶„ì‚°DB (IPFS+OrbitDB) ì»¤ìŠ¤í…€ í›…
    function useDistributedDB(setSystemStatus) {
      const [db, setDb] = useState(null);
      const [nodeId, setNodeId] = useState("...");
      const [messages, setMessages] = useState([]);
      useEffect(() => {
        (async () => {
          // 1. IPFS+OrbitDB ë¸Œë¼ìš°ì € ë…¸ë“œ ìƒì„± (ì™„ì „ ë¶„ì‚°)
          const ipfs = await window.IpfsCore.create();
          const orbitdb = await OrbitDB.createInstance(ipfs);
          const nodeid = (await ipfs.id()).id;
          setNodeId(nodeid.slice(0,16)+"...");
          setSystemStatus(prev=>({...prev, isOnline:true, nodeId: nodeid.slice(0,16)+"..."}));
          // 2. ê¸€ë¡œë²Œ ë©”ì‹œì§€/ì—…ë°ì´íŠ¸ eventlog
          const chatDB = await orbitdb.eventlog("nima-global-chat");
          await chatDB.load();
          setDb(chatDB);
          // 3. ë©”ì‹œì§€ ì‹¤ì‹œê°„ ë™ê¸°í™”
          const update = () => {
            const msgs = chatDB.iterator({ limit: 80 }).collect().map(e=>e.payload.value);
            setMessages(msgs);
            setSystemStatus(prev=>({...prev, totalMessages: msgs.length}));
          };
          chatDB.events.on("replicated", update);
          chatDB.events.on("write", update);
          update();
        })();
      }, []);
      // 4. ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      const sendMessage = async (content, type="user") => {
        if(db && content) {
          await db.add({
            id: Date.now(),
            from: nodeId,
            content, type,
            timestamp: new Date().toLocaleString("ko-KR")
          });
        }
      };
      return { nodeId, messages, sendMessage };
    }

    // ìŒì„±ì¸ì‹ (WebSpeech API)
    function useVoiceInput(onResult) {
      const [isListening, setIsListening] = useState(false);
      const recognitionRef = useRef();
      const start = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) return alert("ìŒì„±ì¸ì‹ ë¯¸ì§€ì›");
        const rec = new SpeechRecognition();
        rec.lang = "ko-KR";
        rec.onresult = (e) => {
          const txt = Array.from(e.results).map(r=>r[0].transcript).join("");
          onResult(txt);
          setIsListening(false);
        };
        rec.onend = () => setIsListening(false);
        rec.start();
        setIsListening(true);
        recognitionRef.current = rec;
      };
      const stop = () => {
        recognitionRef.current?.stop();
        setIsListening(false);
      };
      return { isListening, start, stop };
    }

    // NIMA ë©”ì¸ ì•±
    function NimaApp() {
      const [systemStatus, setSystemStatus] = useState({
        isOnline: false, nodeId: "...", totalMessages: 0
      });
      const [input, setInput] = useState("");
      const [isUpdating, setIsUpdating] = useState(false);
      const { nodeId, messages, sendMessage } = useDistributedDB(setSystemStatus);
      const { isListening, start, stop } = useVoiceInput(txt=>setInput(txt));

      // "ëŒ€í‘œ NEMA" ì§‘ë‹¨ ì—…ë°ì´íŠ¸ ëª…ë ¹ (ex: ìƒˆë²½3ì‹œ ìë™/ìˆ˜ë™)
      const sendGlobalUpdate = async () => {
        setIsUpdating(true);
        await sendMessage("ğŸ› ï¸ ëŒ€í‘œ NEMA ì§‘ë‹¨ ì—…ë°ì´íŠ¸! (ëª¨ë“  ë¦¬ë§ˆ/AI/ì½”ì¹˜ ì¦‰ì‹œ ìµœì‹ í™”)", "update");
        setIsUpdating(false);
      };

      // AI ì½”ì¹˜ ìë™ ì‘ë‹µ (ê°„ë‹¨ ì‹œë®¬ë ˆì´ì…˜)
      const aiCoachRespond = async (lastMsg) => {
        if(lastMsg && lastMsg.type === "user") {
          setTimeout(()=>{
            sendMessage("ğŸ¤– [AIì½”ì¹˜] ë‹µë³€: \""+lastMsg.content.slice(0,30)+"...\" ì— ëŒ€í•œ ì „ë¬¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤!", "ai");
          }, 1500);
        }
      };
      useEffect(()=>{
        if(messages.length>0) {
          const lastMsg = messages[messages.length-1];
          if(lastMsg.type==="user") aiCoachRespond(lastMsg);
        }
      }, [messages]);

      return (
        <div className="flex flex-col h-screen items-center justify-center">
          {/* ìƒë‹¨ ë°” */}
          <header className="w-full flex items-center justify-between px-8 py-4 bg-black/20 border-b border-blue-900 shadow-lg">
            <div className="flex items-center gap-3">
              <span className="text-2xl text-indigo-400 font-bold">NIMA</span>
              <span className="text-sm text-gray-300">ë¶„ì‚° AI/ì½”ì¹˜/ìŒì„± ì‹œìŠ¤í…œ</span>
            </div>
            <div className="flex items-center gap-4 text-xs text-gray-400">
              <span>ë…¸ë“œID: <span className="font-bold text-indigo-300">{nodeId}</span></span>
              <span className={systemStatus.isOnline?"text-green-400":"text-red-400"}>{systemStatus.isOnline?"ì˜¨ë¼ì¸":"ì˜¤í”„ë¼ì¸"}</span>
            </div>
          </header>
          {/* ë©”ì¸ ì»¨í…ì¸  */}
          <main className="flex-1 flex flex-col w-full max-w-2xl p-8 space-y-4">
            {/* ì§‘ë‹¨ ì—…ë°ì´íŠ¸ ë²„íŠ¼ */}
            <div className="flex gap-3 items-center">
              <button
                onClick={sendGlobalUpdate}
                disabled={isUpdating}
                className="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-blue-600 hover:to-indigo-600 text-white rounded-xl px-6 py-3 font-bold shadow transition-all"
              >
                {isUpdating ? "ì—…ë°ì´íŠ¸ ì¤‘..." : "ëŒ€í‘œ NEMA ì§‘ë‹¨ ì—…ë°ì´íŠ¸"}
              </button>
              <button
                onClick={isListening ? stop : start}
                className={`ml-2 px-4 py-3 rounded-xl text-white font-medium shadow ${isListening ? "bg-red-500 animate-pulse" : "bg-gray-700 hover:bg-gray-600"}`}
              >
                {isListening ? "ìŒì„± ì¤‘ì§€" : "ìŒì„± ì…ë ¥"}
              </button>
            </div>
            {/* ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ */}
            <div className="flex-1 bg-gray-900/60 rounded-2xl p-4 mt-2 shadow-inner overflow-y-auto min-h-[360px] max-h-[420px]">
              {messages.length === 0 ?
                <div className="text-gray-400 text-center pt-20">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€í‘œ NEMA ì§‘ë‹¨ ì—…ë°ì´íŠ¸ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
                :
                messages.map((msg, i) => (
                  <div key={i} className={`flex ${msg.type==="user"?"justify-end":"justify-start"} my-2`}>
                    <div className={`px-4 py-2 rounded-2xl max-w-xs ${msg.type==="user" ? "bg-indigo-600 text-white ml-auto":"bg-gray-700/70 text-blue-200"}`}>
                      <div className="text-sm">{msg.content}</div>
                      <div className="text-xs mt-1 text-right opacity-60">{msg.timestamp}</div>
                    </div>
                  </div>
                ))
              }
            </div>
            {/* ì…ë ¥ì°½ */}
            <div className="flex gap-2 items-center">
              <input
                type="text"
                value={input}
                onChange={e=>setInput(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter") sendMessage(input)}}
                className="flex-1 px-5 py-3 rounded-xl bg-gray-800 text-white placeholder-gray-400 border border-gray-700 outline-none"
                placeholder="ë©”ì‹œì§€/ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”..."
              />
              <button
                onClick={()=>sendMessage(input)}
                className="bg-indigo-500 hover:bg-indigo-400 px-5 py-3 rounded-xl text-white font-bold shadow"
              >
                ì „ì†¡
              </button>
            </div>
          </main>
          {/* í‘¸í„° */}
          <footer className="w-full text-center text-xs text-gray-400 py-4 border-t border-blue-900">
            NIMA ë¶„ì‚°AI ì‹œìŠ¤í…œ â“’ 2024 | ì§‘ë‹¨ë™ê¸°í™”Â·ë¬´í•œìƒì„±Â·AIì½”ì¹˜Â·ìŒì„± | "ìƒˆë²½ 3ì‹œ 10ì–µëª… ë™ê¸°í™”"
          </footer>
        </div>
      );
    }

    // ë Œë”ë§
    ReactDOM.createRoot(document.getElementById("root")).render(<NimaApp />);
  </script>
</body>
</html>
