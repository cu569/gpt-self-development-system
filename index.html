// upload.js
// 1) npm init -y
// 2) npm install puppeteer dotenv
// 3) .env 파일에 YT_EMAIL, YT_PASSWORD, VIDEO_PATH, VIDEO_TITLE, VIDEO_DESC, SCHEDULE_DATETIME 세팅

require('dotenv').config();
const puppeteer = require('puppeteer');

(async () => {
  const {
    YT_EMAIL,
    YT_PASSWORD,
    VIDEO_PATH,
    VIDEO_TITLE,
    VIDEO_DESC,
    SCHEDULE_DATETIME // 형식: 'YYYY-MM-DDTHH:mm' 예: '2025-07-25T15:30'
  } = process.env;

  const browser = await puppeteer.launch({
    headless: false,        // 업로드 과정을 눈으로 확인하려면 false
    defaultViewport: null,
    args: ['--no-sandbox','--disable-setuid-sandbox']
  });
  const page = await browser.newPage();

  // 1. YouTube 로그인
  await page.goto('https://accounts.google.com/ServiceLogin');
  await page.type('input[type="email"]', YT_EMAIL, {delay: 50});
  await page.click('#identifierNext');
  await page.waitForTimeout(2000);
  await page.type('input[type="password"]', YT_PASSWORD, {delay: 50});
  await page.click('#passwordNext');
  await page.waitForNavigation({waitUntil: 'networkidle2'});

  // 2. YouTube Studio 업로드 페이지로 이동
  await page.goto('https://studio.youtube.com/channel/UC/upload', {waitUntil: 'networkidle2'});

  // 3. 파일 선택
  const [fileChooser] = await Promise.all([
    page.waitForFileChooser(),
    page.click('input[type="file"]')
  ]);
  await fileChooser.accept([VIDEO_PATH]);

  // 4. 메타데이터 입력
  await page.waitForSelector('#textbox', {visible: true});
  // 제목
  const titleBox = (await page.$$('#textbox'))[0];
  await titleBox.click({clickCount: 3});
  await titleBox.type(VIDEO_TITLE);
  // 설명
  const descBox = (await page.$$('#textbox'))[1];
  await descBox.click();
  await descBox.type(VIDEO_DESC);

  // 5. 예약 업로드 설정
  // '다음' 버튼 3회
  for (let i=0; i<3; i++) {
    await page.click('ytcp-button#next-button');
    await page.waitForTimeout(1000);
  }
  // 공개 설정에서 '예약' 선택
  await page.click('tp-yt-paper-radio-button[name="SCHEDULE"]');
  // 날짜/시간 입력
  await page.evaluate((dt) => {
    const [date, time] = dt.split('T');
    document.querySelector('input#date-input').value = date;
    document.querySelector('input#time-input').value = time;
  }, SCHEDULE_DATETIME);

  // '예약' 버튼 클릭
  await page.click('ytcp-button#done-button');
  await page.waitForTimeout(2000);

  console.log('✅ 예약 업로드 완료:', VIDEO_PATH, '→', SCHEDULE_DATETIME');
  await browser.close();
})();
